<?php

/**
 * @file pw_vote.admin.inc
 *
 */


/**
 * Form builder.
 */
function pw_vote_generate_votes_form($form, &$form_state) {

  // build select box
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', array('pw_petition', 'poll'))
    ->propertyCondition('status', NODE_PUBLISHED);
  $result = $query->execute();
  $options = array();
  if (isset($result['node'])) {
    $nodes = node_load_multiple(array_keys($result['node']));
    foreach ($nodes as $nid => $node) {
      $options[$nid] = $node->title . ' (' . $node->type . ')';
    }
  }
  $form['pw_vote_admin'] = array(
    '#type' => 'select',
    '#title' => t('Content, to generate votes for'),
    '#options' => $options,
    '#default_value' => variable_get('pw_vote_generate_votes_nid'),
    '#required' => TRUE,
  );

  // add default voting behavior
  $voc = taxonomy_vocabulary_machine_name_load('votes');
  $terms = taxonomy_term_load_multiple(array(), array('vid' => $voc->vid));
  $options = array('random' => t('By random'));
  $default_tid = 'random';
  foreach ($terms as $tid => $term) {
    $options[$tid] = $term->name;
    if($term->name == 'no-show') {
      $default_tid = $tid;
    }
  }
  $form['pw_vote_admin_default_vote'] = array(
    '#type' => 'select',
    '#title' => t('Default voting behavior'),
    '#options' => $options,
    '#default_value' => $default_tid,
    '#required' => TRUE,
  );

  $form['pw_vote_admin_delete_existing'] = array(
    '#type' => 'checkbox',
    '#title' => t('Delete all votes for this content before generate new ones'),
  );

  // add submit button
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Generate Votes',
  );

  // add custom validation
  $form['#validate'][] = 'pw_vote_admin_validate';

  // add custom submit handler
  $form['#submit'][] = 'pw_vote_admin_submit';
  return $form;
}


/**
 * Form validate handler.
 */
function pw_vote_admin_validate($form, &$form_state) {

  // check if yes / no in vocabulary votes exists
  $voc = taxonomy_vocabulary_machine_name_load('votes');
  $terms = taxonomy_term_load_multiple(array(), array('vid' => $voc->vid));
  $vote_tids = array_keys($terms);
  if (sizeof($vote_tids) == 0) {
    form_set_error('error', 'No items found in taxonomy votes.');
  }
}

/**
 * Form submit handler.
 */
function pw_vote_admin_submit($form, &$form_state) {

  global $user;

  // selected node
  $content_nid = $form['pw_vote_admin']['#value'];
  $node = node_load($content_nid);
  variable_set('pw_vote_generate_votes_nid', $content_nid);

  // wrap node
  $w_node = entity_metadata_wrapper('node', $node);

  // parliament
  $parliament = $w_node->field_parliament->value();

  // load yes/no etc
  if($form['pw_vote_admin_default_vote']['#value'] == 'random') {
    $voc = taxonomy_vocabulary_machine_name_load('votes');
    $terms = taxonomy_term_load_multiple(array(), array('vid' => $voc->vid));
    $vote_tids = array_keys($terms);
  }

  // delete votes on this node
  if($form['pw_vote_admin_delete_existing']['#value'] == 1) {
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'vote')
      ->fieldCondition('field_vote_node', 'target_id', $content_nid);
    $result = $query->execute();
    if ($result['node']) {
      $nids = array_keys($result['node']);
      node_delete_multiple($nids);
    }
  }

  // try to remove duplicates
  else{

    // load all existing votes on node
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'vote')
      ->fieldCondition('field_vote_node', 'target_id', $content_nid);
    $result = $query->execute();

    if (isset($result['node'])) {


      $nodes = node_load_multiple(array_keys($result['node']));
      $users = array();
      $nodes_cleared = 0;

      // iterate through votes
      foreach($nodes as $vote_nid => $node){
        $field_user = field_get_items('node', $node, 'field_vote_user');

        if(!array_key_exists($field_user[0]['target_id'], $users)){
          $users[$field_user[0]['target_id']] = $vote_nid;
        }

        // duplicate exists and user voted on current item by him/herself
        elseif($field_user[0]['target_id'] == $node->uid){

          // delete from array
          node_delete($users[$field_user[0]['target_id']]);
          $nodes_cleared++;
        }

        // duplicate exists and current vote was generated by system
        else{

          // delete current item
          node_delete($node->nid);
          $nodes_cleared++;
        }
      }
      if($nodes_cleared > 0){
        drupal_set_message('cleared ' . $nodes_cleared . ' duplicates!', 'warning');
      }
    }
  }

  // retrieve all deputies of related parliament
  $deputies = db_query("SELECT uac.uid FROM user_archive_cache uac WHERE uac.user_role = 'deputy' AND uac.parliament_name = :name", array(':name' => $w_node->field_parliament->label()))->fetchCol();

  // create vote for each deputy
  $count_generated = 0;
  foreach ($deputies as $uid) {

    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'vote')
      ->fieldCondition('field_vote_node', 'target_id', $content_nid)
      ->fieldCondition('field_vote_user', 'target_id', $uid);
    $result = $query->count()->execute();

    if($result == 0) {

      // user fields
      $deputy = user_load($uid);

      if($deputy){
        $field_firstname = field_get_items('user', $deputy, 'field_user_fname');
        $field_lastname = field_get_items('user', $deputy, 'field_user_lname');

        // create new vote
        $vote = new stdClass();
        $vote->title = "Vote by " . $field_firstname[0]['value'] . ' ' . $field_lastname[0]['value'];
        $vote->type = "vote";
        $vote->language = LANGUAGE_NONE;
        $vote->status = 1;
        $vote->uid = $user->uid;
        $vote->field_vote_node[$vote->language][]['target_id'] = $content_nid;
        $vote->field_parliament[$vote->language][]['tid'] = $parliament[0]->tid;
        $vote->field_vote_user[$vote->language][]['target_id'] = $uid;
        $vote->body[$vote->language][]['format']= 'plain_text';

        // voting behavior
        if($form['pw_vote_admin_default_vote']['#value'] == 'random') {
          $vote->field_vote[$vote->language][]['tid'] = $vote_tids[rand(0, sizeof($vote_tids) - 1)];
        }
        else {
          $vote->field_vote[$vote->language][]['tid'] = $form['pw_vote_admin_default_vote']['#value'];
        }

        // save vote
        node_save($vote);

        // count for user output
        $count_generated++;
      }
    }
  }

  drupal_set_message($count_generated . " votes generated.");
}
